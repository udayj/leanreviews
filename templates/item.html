{% extends "base.html" %}
{% block content %}


      <!-- Jumbotron -->
      <div class="row">
        <div id="userid" style="display:none">{{current_user.id}}</div>
        <div class="span6" style="position:relative;top:15px;">
          
          <input id="search" name="name" class="span5" type="text" onkeydown="if (event.keyCode==13) { search();}"
           placeholder="Search for a review eg. Tom Cruise" >
          <button type="button" class="btn btn-primary" onclick="search()" style="position:relative;top:-5px;"> Search</button>


      
    </div>
  </div>
<br>
      <!-- Example row of columns -->
        <div class="container">
        <div class="row">
          <div class="span12">

      	   <h2 style="display:inline"> {{review['name']}} </h2> <br><br> <span class="btn btn-success" style="position:relative;top:-5px">{{review['upvote']}} Up votes</span>  <span class="btn btn-warning" style="position:relative;top:-5px">
           {{review['downvote']}} Down votes</span>
           <br>
           <h4> {{review['description']}} - Still confused about what this refers to? Find out more on <a href="http://www.google.com/search?q={{review['name']}}">Google</a>.
            <br>
            Can't find what you are looking for? Add a new review <a href="/add_new">here</a>

           </h4>
      </div>
    </div>
      <div class="row">
        <div style="display:none" id="review_words">
          {{review['data']}}
        </div>
        <div class="span8" id="word_cloud">
        </div>
        <div class="row">
        <div class="span4" style="position:relative;top:30px;">
          <div class="row">
            <div class="span4">
          Rate this: <span class="btn btn-success" onclick="send_rating('{{review['id']}}','up_vote')"> Up Vote</span> <span class="btn btn-warning" onclick="send_rating('{{review['id']}}','down_vote')"> Down Vote</span>
            </div>
            <br>
            <div class="span4" id="thanks_vote" style="display:none">
            </div>
          </div>

          <hr>
          <div class="row">
            <div class="span4">
              Your review - in 20 characters or less<br>
              <input id="new_review" name="name" class="span4" type="text"  placeholder="Search for a review eg. Tom Cruise" >
              <br>
              <button type="button" class="btn btn-primary" onclick="send_review('{{review['id']}}')">Submit</button>
            </div>
            <br>
            <div class="span4" id="thanks_review" style="display:none">
            </div>
            <div class="span4" id="share_fb" onclick="create_png('{{review['id']}}')">
              Share on Facebook
            </div>
          </div>

        </div>
      </div>

      </div>
      

    </div>

      <hr>
{% endblock %}
      <div class="footer">
        <p>&copy; LeanReviews.com 2013. All rights reserved.</p>
      </div>

    </div> <!-- /container -->

{% block javascript %}
    <script>
    $(document).ready(function() {
    $("input#search").autocomplete({
    source: items
});});
    function search()
    {
        var name=document.getElementById("search");
        if(name==null || name.value.trim()=="")
          return;
        window.location='/item?name='+name.value.trim();
    }

    var fill = d3.scale.category20();
    dataset=jQuery.parseJSON($(review_words).html());
    values=[]
    for(var key in dataset)
    {
      

      values.push(dataset[key]['size']);
    }
var words_main=[];
    
    function draw_word_cloud(id,review_words){
      var fontSize = d3.scale.linear()
                   .domain([5, d3.max(values)])
                  .range([10, 70]);
     d3.layout.cloud().size([600,450])
      .words(jQuery.parseJSON($(review_words).html()))
      .font("Impact")
      .fontSize(function(d) { return parseInt(fontSize(d.size)); })
      .rotate(function(d) { return ~~(Math.random() * 5) * 10 - 10; })
      .on("end", draw)
      .start();

  function draw(words) {
    words_main=words;
    d3.select(id).append("svg")
        .attr("width", 600)
        .attr("height", 450)
      .append("g")
        .attr("id","word_reviews")
        .attr("transform", "translate(280,215)")
      .selectAll("text")
        .data(words)
      .enter().append("text")
        .style("font-size", function(d) { return d.size + "px"; })
        .style("font-family", "sans-serif")
        .style("fill", function(d, i) { return fill(i); })
        .attr("text-anchor", "middle")
        .attr("transform", function(d) {
          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
        })
        .text(function(d) { return d.text; });
    $('#word_reviews').append('<div class="fb-like" data-href="http://3x9t.localtunnel.com" data-send="false" data-width="450" data-show-faces="false"></div>');
  }
}
    var scale=d3.scale.linear()
              .domain([0,160])
              .range([0,400])
    draw_word_cloud("#word_cloud","#review_words");
    var chart = d3.select("#word_cloud").append("div")
    .attr("class", "chart")
    .style('font-size','17px')
    .text('Review Frequencies')
    
    var data=jQuery.parseJSON($('#review_words').html())
    chart.selectAll("div")
    .data(dataset)
    .enter().append("div")
    .attr('id',function(d) {return '123'+d['text'].replace(new RegExp(" ","g"),'-');})
    

    for(var value in dataset)
    {
      /* d3.select('#123'+dataset[value]['text'])
      .append("div")
      .style("display","inline")
      .style("width", function(d) { return parseInt(scale(d['size'])) + "px"; })
      .attr('title',function(d){ return d['text'];})
      .text(function(d) { return d['size']; })
      .style("font-size","10px");*/
       /*d3.select('#123'+dataset[value]['text'])
      .append("div")
      .style("display","inline")
      .style("width", parseInt(scale(dataset[value]['size'])) + "px")
      .attr('title',dataset[value]['text'])
      .text(dataset[value]['size'])
      .style("font-size","10px");*/

      $('#123'+dataset[value]['text'].replace(new RegExp(" ","g"),'-')).append("<div class='span5' style='display:inline;font-size:10px;width:"+
        parseInt(scale(dataset[value]['size']))+"px' title='"+dataset[value]['text']+"'></div>");

      $('#123'+dataset[value]['text'].replace(new RegExp(" ","g"),'-')).append("<span style='position:relative;top:-7px;font-size:13px'>"+dataset[value]['text']+"</span><br>");
      
      
    }
    function create_png(id)
    {
    var canvas = document.createElement("canvas"),
      c = canvas.getContext("2d");
  canvas.width = 600;
  canvas.height = 450;
  c.translate(600 >> 1, 450 >> 1);
  c.scale(scale, scale);
  words_main.forEach(function(word, i) {
    c.save();
    c.translate(word.x, word.y);
    c.rotate(word.rotate * Math.PI / 180);
    c.textAlign = "center";
    c.fillStyle = fill(word.text.toLowerCase());
    c.font = word.size + "px " + word.font;
    c.fillText(word.text, 0, 0);
    c.restore();
  });
  var image=canvas.toDataURL("image/png");
  //alert(image);
  var pos=image.indexOf(",");
  image=image.substr(pos+1);
  //alert(image);

        $.ajax({
  type: "POST",
  url: "/share_facebook",
  data: {id:id,image:image},
  
  success: function(data)
  {
    
    if(!data.success)
    {
      
      window.location.href="/signup";
    }
    else{
    var userid=$('#userid').html();
    $('#thanks_vote').css('display','');
    $('#thanks_vote').html('Thanks for sharing it with your friends.');
  }
},
  fail: function()
  {
    $('#thanks_vote').css('display','');
    $('#thanks_vote').html('Can\'t share. Login via facebook here to grant permission to share.');
    
  }
}).done(function( msg ) {
 // document.getElementById("user_tips").value="";
  //alert("Thanks for helping us improve!");
});
     
  }
    


     </script>
     <script>
     function send_rating(id,vote)
     {
      $.ajax({
  type: "POST",
  url: "/rate_item",
  data: {id:id,vote:vote},
  
  success: function(data)
  {
    
    if(!data.success)
    {
      
      window.location.href="/signup";
    }
    else{
    var userid=$('#userid').html();
    $('#thanks_vote').css('display','');
    $('#thanks_vote').html('Thanks for your vote. You just earned a <a href="/profile?id='+userid+'">kudo</a>');
  }
},
  fail: function()
  {
    $('#thanks_vote').css('display','');
    $('#thanks_vote').html('Can\'t submit vote. Try back later!');
    
  }
}).done(function( msg ) {
 // document.getElementById("user_tips").value="";
  //alert("Thanks for helping us improve!");
});
}

</script>
<script>
function send_review(id)
     {
      var review=$('#new_review').val();
      if(review==null || review.trim()=="" || review.length==0)
      {
        alert("Review cannot be empty");
        return;
      }
      if(review.length>25)
      {
        alert("Review should be word or phrase with max of 25 characters");
        return;
      }
      $.ajax({
  type: "POST",
  url: "/review_item",
  data: {id:id,review:$('#new_review').val()},
  
  success: function(data)
  {
    if(!data.success)
    {
      window.location.href="/signup"

    }
    else{
      var userid=$('#userid').html();
    $('#thanks_review').css('display','');
    $('#thanks_review').html('Thanks for your review. You just earned a <a href="/profile?id='+userid+'">kudo</a>');
  }
  },
  fail: function()
  {
    $('#thanks_review').css('display','');
    $('#thanks_review').html('Can\'t submit review. Try back later!');
    
  }
}).done(function( msg ) {
 // document.getElementById("user_tips").value="";
  //alert("Thanks for helping us improve!");
});
}
</script>
{% endblock %}


<!--
3 model plate - 4 Pc.
3 Model box   - 4 Pc.
6A Switch - 4 Pc.-->
